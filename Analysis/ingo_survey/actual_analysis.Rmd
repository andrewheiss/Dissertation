---
title: "Analysis for survey chapter"
author: "Andrew Heiss"
date: "`r format(Sys.time(), '%B %e, %Y')`"
output: 
  html_document: 
    css: ../html/fixes.css
    code_folding: hide
    toc: yes
    toc_float: true
    toc_depth: 4
    highlight: pygments
    theme: cosmo
    self_contained: no
    includes:
      after_body: ../html/add_home_link.html
bibliography: /Users/andrew/Dropbox/Readings/Papers.bib
csl: /Users/andrew/.pandoc/csl/american-political-science-association.csl
...


```{r load-libraries-data, message=FALSE}
knitr::opts_chunk$set(cache=FALSE, fig.retina=2,
                      tidy.opts=list(width.cutoff=140),  # For code
                      options(width=140))  # For output

library(plyr)  # first because of productplots
library(tidyverse)  # yay hadley
library(magrittr)  # For %T>%
library(forcats)  # yay clean factors
library(stringr)  # yay clean string manipulation
library(productplots)
library(pander)
library(DT)  # yay fancy HTML tables
library(tm)  # yay text analysis
library(countrycode)
library(riverplot)
library(pryr)
library(gridExtra)

panderOptions('table.split.table', Inf)
panderOptions('table.split.cells', Inf)
panderOptions('keep.line.breaks', TRUE)
panderOptions('table.style', 'multiline')
panderOptions('table.alignment.default', 'left')

options("readr.num_columns" = 0)

source(file.path(PROJHOME, "Analysis", "lib", "graphic_functions.R"))
source(file.path(PROJHOME, "Analysis", "lib", "cat_analysis.R"))

# Reproducibility
my.seed <- 1234
set.seed(my.seed)

# Bayesian stuff
CHAINS <- 4
ITER <-2000
WARMUP <- 1000
options(mc.cores = 1)  # No need to parallelize with simple models

# Treat ordered factors as treatments in models
options(contrasts=rep("contr.treatment", 2))

# Load cleaned, country-based survey data (*with* the Q4\* loop)
survey.clean.all <- readRDS(file.path(PROJHOME, "Data", "data_processed", 
                                      "survey_clean_all.rds"))

# Load cleaned, organization-based data (without the Q4 loop)
survey.orgs.clean <- readRDS(file.path(PROJHOME, "Data", "data_processed", 
                                       "survey_orgs_clean.rds"))

# Load cleaned, country-based data (only the Q4 loop)
survey.countries.clean <- readRDS(file.path(PROJHOME, "Data", "data_processed", 
                                            "survey_countries_clean.rds")) %>%
  mutate(Q4.4_collapsed =
           fct_recode(Q4.4, Registered = "Yes", `Not registered` = "No", 
                      NULL = "Don't know"),
         Q4.4_collapsed = ordered(Q4.4_collapsed)) %>%
  mutate(Q4.11_collapsed = 
           fct_collapse(Q4.11,
                        Negative = c("Extremely negative", "Somewhat negative"),
                        Neither = c("Neither positive nor negative"),
                        Positive = c("Somewhat positive", "Extremely positive"),
                        NULL = c("Don't know", "Prefer not to answer")),
         Q4.11_collapsed = ordered(Q4.11_collapsed)) %>%
  mutate(Q4.13_collapsed = 
           fct_collapse(Q4.13,
                        "Very familiar" = c("Extremely familiar", "Very familiar"),
                        "Somewhat familiar" = c("Moderately familiar", "Slightly familiar"),
                        "Not familiar at all" = c("Not familiar at all"),
                        NULL = c("Don't know")),
         Q4.13_collapsed = ordered(Q4.13_collapsed)) %>%
  mutate(Q4.14_collapsed = 
           fct_collapse(Q4.14,
                        "At least once a year" = c("Once a month", "Once a year"),
                        "Once every few years" = c("Once every few years"),
                        "Rarely or never" = c("Rarely", "Never"),
                        NULL = c("Don't know")),
         Q4.14_collapsed = ordered(Q4.14_collapsed)) %>%
  mutate(Q4.17_collapsed = 
           fct_collapse(Q4.17,
                        "Not restricted" = c("Not restricted at all"),
                        "Very restricted" = c("Very restricted",
                                              "Extremely restricted"),
                        NULL = c("Don’t know")),
         Q4.17_collapsed = ordered(Q4.17_collapsed))

# External data
full.data <- readRDS(file.path(PROJHOME, "Data", "data_processed",
                               "full_data.rds"))

# Load Robinson map projection
countries.ggmap <- readRDS(file.path(PROJHOME, "Data", "data_processed",
                                     "countries110_robinson_ggmap.rds"))

# All possible countries (to fix the South Sudan issue)
possible.countries <- data_frame(id = unique(as.character(countries.ggmap$id)))

# Survey responses
great.none.dk <- c("A great deal", "A lot", "A moderate amount",
                   "A little", "None at all", "Don't know", "Not applicable")
great.none <- great.none.dk[1:5]

# Show two analyze.cat.var tables side-by-side
side.by.side <- function(table1, table2) {
  # Use diff for the two column effect!
  # http://stackoverflow.com/a/9214177/120898
  tmp1 <- tempfile()
  tmp2 <- tempfile()
  
  cat(capture.output( analyze.cat.var(table1) ), sep="\n", file=tmp1)
  cat(capture.output( analyze.cat.var(table2) ), sep="\n", file=tmp2)
 
  # system does weeeeird stuff with knitr (see https://github.com/yihui/knitr/issues/1203),
  # so system(..., intern=TRUE) + cat(paste(..., collapse="\n)) does the trick
  system.output <- suppressWarnings(
    system2('diff', args=c('-y', '-W', '120', tmp1, tmp2), stdout=TRUE))
  
  cat(paste(system.output, collapse="\n"))
}
```

## General respondent details

### How many NGOs responded?

There are valid responses from `r nrow(survey.orgs.clean)` NGOs.


### How did respondents differ from nonrespondents?

See [survey completion rate calculations](completion_rates.html#differences_between_responders_and_nonresponders).


### How many respondents answered questions for more than one country?

```{r calc-more-than-one}
more.than.one <- survey.countries.clean %>% 
  filter(loop.number > 1) %>% 
  nrow() %T>%
  {assign("more.than.one.perc",
          scales::percent(. / nrow(survey.orgs.clean)),
          pos=1)}
```

`r more.than.one` (`r more.than.one.perc`) respondents answered questions for more than one country.


### How did respondents treat open-ended questions?

```{r calc-open-ended}
open.ended <- survey.clean.all %>%
  select(clean.id, loop.number, contains("TEXT"),
         Q3.9, Q3.10, Q3.11, Q3.12, Q3.13,
         Q4.10, Q4.12, Q4.18, Q4.20, Q5.1,
         -Q2.3_TEXT, -Q3.1_other_TEXT)

# How many open-ended questions were there?
n.open.ended <- open.ended %>% ncol() - 2

# How many open-ended questions did respondents answer?
open.ended.respondents <- open.ended %>%
  gather(key, value, -clean.id, -loop.number) %>%
  filter(!is.na(value)) %>%
  group_by(clean.id, loop.number) %>%
  summarise(n = n())

# How many people skipped all open-ended questions?
skipped <- sum(!(survey.orgs.clean$clean.id %in%
                   open.ended.respondents$clean.id)) %T>%
                   {assign("skipped.perc",
          scales::percent(. / nrow(survey.orgs.clean)),
          pos=1)}
```

There were `r n.open.ended` questions in the survey, and only `r skipped` (`r skipped.perc`) declined to answer any of them. Most answered between 8–16 of them.

```{r plot-open-ended-dist, fig.width=6, fig.height=2}
ggplot(open.ended.respondents, aes(x=n)) +
  geom_histogram(binwidth=1) +
  labs(x="Number of open-ended questions answered", y="Count") +
  theme_ath()
```


### Did NGOs choose easier countries to answer about?

NGOs chose one of the selected countries for the second half of the survey. Did they choose countries that were easier or harder to work in? Did the restrictivness of the country's civil society regulatory environment influence their answer?

```{r calc-easier-harder}
csre.only <- full.data %>%
  select(iso3, cs_env_sum) %>%
  group_by(iso3) %>%
  mutate(csre.fixed = zoo::na.locf(cs_env_sum, na.rm=FALSE)) %>%  # Forward-fill CSRE
  summarise(csre.mean = mean(csre.fixed, na.rm=TRUE),
            csre.last = last(csre.fixed),
            csre.min = min(csre.fixed, na.rm=TRUE),
            csre.max = max(csre.fixed, na.rm=TRUE))

csre.selected <- survey.clean.all %>%
  select(clean.id, home_iso3 = Q2.2_iso3, target_iso3 = Q2.5_iso3, answered_iso3 = Q4.1_iso3) %>%
  unnest(target_iso3) %>%
  left_join(csre.only, by=c("target_iso3" = "iso3")) %>%
  left_join(csre.only, by=c("answered_iso3" = "iso3"), suffix=c("_target", "_answered"))
  
csre.selected.answered <- csre.selected %>%
  group_by(clean.id, answered_iso3) %>%
  summarise(avg.csre.all.targets = mean(csre.mean_target, na.rm=TRUE),
            avg.csre.answered = mean(csre.mean_answered, na.rm=TRUE)) %>%
  filter(!is.na(avg.csre.answered)) %>%
  mutate(restriction = case_when(
    avg.csre.answered < avg.csre.all.targets ~ "More restrictive than average",
    avg.csre.answered > avg.csre.all.targets ~ "Less restrictive than average",
    avg.csre.answered == avg.csre.all.targets ~ "Average restrictiveness"
  ))

plot.csre.selected.answered <- ggplot(csre.selected.answered, 
       aes(y=avg.csre.all.targets, x=avg.csre.answered)) + 
  geom_abline(slope=1, size=0.25) +
  geom_vline(xintercept=0, size=0.25) +
  geom_point(aes(color=restriction), size=0.75) + 
  labs(x="Average CSRE in country answered",
       y="Average CSRE in all countries selected") +
  scale_color_manual(values=ath.palette("palette1"), name=NULL) +
  coord_cartesian(xlim=c(-6, 6.5), ylim=c(-6, 6.6)) +
  theme_ath(8)
```

To some extent, yes. 45% of respondents answered questions about countries that were less restrictive than the average restrictiveness of their total portfolio of countries.

```{r tbl-easier-harder, results="asis"}
csre.selected.answered %>%
  group_by(restriction) %>%
  summarize(total = n()) %>%
  mutate(prop = total / sum(total)) %>%
  pandoc.table()
```

The scatterplot shows a kind of equal distribution of easier vs. harder (45%
vs. 35%). The distribution shows this a little differently, with the country
answered skewed left.

```{r plot-easier-harder, fig.width=6, fig.height=2.5}
csre.selected.answered.dist <- csre.selected.answered %>%
  gather(key, value, avg.csre.all.targets, avg.csre.answered) %>%
  mutate(key = fct_recode(key, 
                          `All countries selected   ` = "avg.csre.all.targets",
                          `Country answered` = "avg.csre.answered"))

plot.csre.selected.answered.dist <- ggplot(csre.selected.answered.dist,
                                           aes(x=value, fill=key)) + 
  geom_density(alpha=0.5, color=NA) + 
  scale_fill_manual(values=ath.palette("palette1")[4:5], name=NULL) +
  labs(x="CSRE", y=NULL) +
  theme_ath(8) + 
  theme(panel.grid.major.y=element_blank(),
        axis.text.y=element_blank())

plot.csre.selected.answered.both <- cbind(ggplotGrob(plot.csre.selected.answered),
                                          ggplotGrob(plot.csre.selected.answered.dist))

grid::grid.draw(plot.csre.selected.answered.both)

fig.save.cairo(plot.csre.selected.answered.both,
               filename="3-easier-harder", 
               width=6, height=2.5)
```


### Who in the organization responded to the survey?

```{r plot-who-responded, fig.width=6, fig.height=3}
df.plot.respondents <- survey.orgs.clean %>%
  group_by(Q2.3) %>%
  summarise(num = n()) %>%
  arrange(num) %>% 
  mutate(question = ordered(fct_inorder(Q2.3)))

plot.respondents <- ggplot(df.plot.respondents, aes(x=num, y=question)) +
  geom_barh(stat="identity") +
  scale_x_continuous(expand=c(0, 0),
                     sec.axis = sec_axis(~ . / sum(df.plot.respondents$num),
                                         labels=scales::percent)) +
  labs(x="Respondents", y=NULL) +
  theme_ath()

plot.respondents +
  labs(title="Who filled out the survey?",
       subtitle="Q2.3: What is your position in your organization?")
```

Lots of others. Who are the others?

```{r tbl-who-responded-others}
position.in.org <- survey.orgs.clean %>%
  filter(!is.na(Q2.3_TEXT)) %>%
  mutate(position.in.org = str_to_title(Q2.3_TEXT)) %>% 
  group_by(position.in.org) %>%
  summarise(num = n()) %>%
  mutate(prop = num / sum(num)) %>%
  arrange(desc(num))

datatable(position.in.org) %>% formatPercentage("prop", 2)
```


## Where are NGOs based?

### How are these NGOs distributed by HQ?

```{r tbl-hq-countries}
df.hq.countries <- survey.orgs.clean %>%
  group_by(Q2.2_iso3) %>%
  summarise(num.ngos = n()) %>%
  ungroup() %>%
  # Combine with list of all possible mappable countries
  right_join(possible.countries, by=c("Q2.2_iso3"="id")) %>%
  mutate(num.ceiling = ifelse(num.ngos >= 30, 30, num.ngos),
         prop = num.ngos / sum(num.ngos, na.rm=TRUE),
         country.name = countrycode(Q2.2_iso3, "iso3c", "country.name"),
         presence = num.ngos >= 1) %>%
  arrange(desc(num.ngos))

df.hq.countries %>% 
  select(country.name, num.ngos, prop) %>%
  datatable() %>% formatPercentage("prop", 2)
```

### Number of unique HQ countries

`r sum(df.hq.countries$presence, na.rm=TRUE)`

### Regional distribution of HQ countries

```{r tbl-hq-regions, results="asis"}
df.hq.regions <- df.hq.countries %>%
  filter(!is.na(num.ngos)) %>%
  mutate(region = countrycode(Q2.2_iso3, "iso3c", "continent"),
         region = ifelse(Q2.2_iso3 == "TWN", "Asia", region)) %>%
  mutate(region = recode(region, Oceania = "Asia &\nOceania", Asia = "Asia &\nOceania")) %>%
  group_by(region) %>%
  summarise(num = sum(num.ngos, na.rm=TRUE)) %>% ungroup() %>%
  mutate(prop = num / sum(num)) %>%
  arrange(desc(num)) %>%
  mutate(region = ordered(fct_rev(fct_inorder(region))))

df.hq.regions %>% pandoc.table()
```

```{r plot-hq-regions, fig.width=6, fig.height=3}
plot.hq.regions <- ggplot(df.hq.regions, aes(x=num, y=region)) +
  geom_pointrangeh(aes(xmin=0, xmax=num)) +
  scale_x_continuous(sec.axis = sec_axis(~ . / sum(df.hq.regions$num),
                                         labels=scales::percent)) +
  labs(x="Respondents based in region", y=NULL) +
  theme_ath() + theme(panel.grid.major.y=element_blank())

plot.hq.regions +
  labs(title="Region of headquarters",
       subtitle="Q2.2: Where is your organization's headquarters? (summarized by region)")
```

### Countries with at least one response

```{r plot-hq-presence}
plot.hq.map.presence <- ggplot(df.hq.countries, aes(fill=presence, map_id=Q2.2_iso3)) +
  geom_map(map=countries.ggmap, size=0.15, colour="black") + 
  expand_limits(x=countries.ggmap$long, y=countries.ggmap$lat) + 
  coord_equal() +
  scale_fill_manual(values=c("#0074D9", "#FFFFFF"), na.value="#FFFFFF", guide=FALSE) +
  theme_ath_map()

plot.hq.map.presence + 
  labs(title="Countries with at least one response",
       subtitle="Q2.2: Where is your organization's headquarters?")
```

### Responses per country (30 NGO ceiling)

```{r plot-hq-presence-ceiling}
plot.hq.map.scale <- ggplot(df.hq.countries, aes(fill=num.ceiling, map_id=Q2.2_iso3)) +
  geom_map(map=countries.ggmap, size=0.15, colour="black") + 
  expand_limits(x=countries.ggmap$long, y=countries.ggmap$lat) + 
  coord_equal() +
  scale_fill_gradient(low="#4397DF", high="#003059", breaks=seq(0, 30, 10), 
                      labels=c(paste(seq(0, 20, 10), "  "), "20+"),
                      na.value="#FFFFFF", name="NGOs based in country",
                      guide=guide_colourbar(ticks=FALSE, barwidth=6)) +
  theme_ath_map() +
  theme(legend.position="bottom", legend.key.size=unit(0.65, "lines"),
        strip.background=element_rect(colour="#FFFFFF", fill="#FFFFFF"))

plot.hq.map.scale + 
  labs(title="Number of responding NGOs around the world",
       subtitle="Q2.2: Where is your organization's headquarters? (30 NGO ceiling)")

fig.save.cairo(plot.hq.map.scale, filename="3-hq-countries",
               width=5, height=3)
```


## Where do NGOs work?

### How are these NGOs distributed by target country?

```{r tbl-target-countries}
df.work.countries.all <- survey.orgs.clean %>%
  unnest(Q2.5_iso3) %>%
  group_by(Q2.5_iso3) %>%
  summarise(num = n()) %>%
  ungroup() %>%
  # Combine with list of all possible mappable countries
  right_join(possible.countries, by=c("Q2.5_iso3"="id")) %>%
  mutate(prop = num / sum(num, na.rm=TRUE),
         country.name = countrycode(Q2.5_iso3, "iso3c", "country.name"),
         presence = num >= 1) %>%
  arrange(desc(num))

df.work.countries.answered <- survey.clean.all %>%
  group_by(Q4.1_iso3) %>%
  summarise(num = n())

df.work.countries.all %>% 
  select(country.name, num, prop) %>%
  datatable() %>% formatPercentage("prop", 2)
```

### Number of unique target countries

Respondents indicated working in `r sum(df.work.countries.all$presence, na.rm=TRUE)` unique countries and answered questions about their work in `r nrow(df.work.countries.answered)` unique countries. 


### Countries per response

```{r plot-countries-per-response, fig.width=6, fig.height=3, results="asis"}
countries.per.response <- survey.orgs.clean %>%
  unnest(Q2.5_iso3) %>%
  group_by(clean.id) %>%
  summarise(num = n()) %>%
  ungroup()

pandoc.table(summary(countries.per.response$num))

countries.per.response %>%
  count(num) %>% mutate(prop = n / sum(n)) %>%
  slice(1:5) %>% pandoc.table()

plot.countries.per.response <- ggplot(data=countries.per.response,
                                      aes(x=num)) +
  labs(x="Number of countries selected", y="Frequency") +
  geom_histogram(binwidth=2) + theme_ath()
plot.countries.per.response

fig.save.cairo(plot.countries.per.response,
               filename="3-countries-per-response",
               width=5, height=2)
```


### Countries selected

#### Flows between regions

```{r tbl-continents-marked, results="asis"}
continents.marked <- survey.orgs.clean %>%
  select(home = Q2.2_iso3, target = Q2.5_iso3) %>%
  unnest(target) %>%
  mutate_at(vars(home, target), funs(continent = countrycode(., "iso3c", "continent"))) %>%
  mutate_at(vars(home_continent, target_continent),
            funs(recode(., Oceania = "Asia &\nOceania", Asia = "Asia &\nOceania"))) %>%
  group_by(home_continent, target_continent) %>%
  summarize(times.marked = n()) %>%
  filter(!is.na(home_continent), !is.na(target_continent)) %>%
  group_by(home_continent) %>%
  mutate(perc.home = times.marked / sum(times.marked)) %>%
  group_by(target_continent) %>%
  mutate(perc.target = times.marked / sum(times.marked)) %>%
  ungroup()

continents.marked %>% pandoc.table()
```

```{r plot-continents-marked-river}
edges.fancy <- continents.marked %>%
  select(N1 = home_continent, N2 = target_continent, Value = times.marked) %>%
  mutate(N2 = paste0(N2, " ")) %>%
  arrange(Value) %>%
  as.data.frame()

nodes.fancy <- edges.fancy %>%
  select(-Value) %>%
  gather(X, ID) %>%
  mutate(x = ifelse(X == "N1", 1, 2)) %>%
  distinct(ID, X, .keep_all=TRUE) %>%
  left_join(cont.colors, by="ID") %>%
  select(ID, x, col) %>%
  as.data.frame()

continents.river <- makeRiver(nodes.fancy, edges.fancy)

# Save plot to an object using a null PDF device
# http://stackoverflow.com/a/14742001/120898
# pdf(NULL)
# dev.control(displaylist="enable")
# plot(continents.river, srt=0, lty=0)
# text(1, 0, "HQ region\n", adj=c(0.5, -0.5), font=2)
# text(2, 0, "Host region\n", adj=c(0.5, -0.5), font=2)
# countries.marked.plot <- recordPlot()
# invisible(dev.off())
#
# THIS IS AMAZING. This total beats recordPlot().
# Use pryr's active binding function (%<a-%) to essentially save a chunk of R
# code to an object that can then get re-run later, like a macro.
countries.marked.plot %<a-% {
  plot(continents.river, srt=0, lty=0)
  text(1, 0, "HQ", adj=c(0.5, -0.5), font=2)
  text(2, 0, "Target", adj=c(0.5, -0.5), font=2)
  text(1.5, 0, "Countries selected\n", adj=c(0.5, -0.5), font=2)
}
```

#### Overall summary

```{r tbl-work-continents, results="asis"}
df.target.regions <- continents.marked %>%
  group_by(target_continent) %>%
  summarise(times.marked = sum(times.marked)) %>%
  mutate(perc.target = times.marked / sum(times.marked)) %>%
  arrange(times.marked) %>%
  mutate(target_continent = fct_inorder(target_continent))

df.target.regions %>% pandoc.table()
```

```{r plot-work-continents, fig.width=6, fig.height=3}
plot.target.regions <- ggplot(df.target.regions, aes(x=times.marked, y=target_continent)) +
  geom_barh(stat="identity") +
  scale_x_continuous(expand=c(0, 0),
                     sec.axis = sec_axis(~ . / sum(df.target.regions$times.marked),
                                         labels=scales::percent)) +
  labs(x="Times marked", y=NULL) +
  theme_ath()

plot.target.regions +
  labs(title="Region of work country",
       subtitle="Q2.5: Where does your organization work? (summarized by region)")
```

### Countries answered

#### Flows between regions

```{r tbl-continents-answered, results="asis"}
continents.answered <- survey.clean.all %>%
  select(home = Q2.2_iso3, target = Q4.1_iso3) %>%
  mutate_at(vars(home, target), funs(continent = countrycode(., "iso3c", "continent", custom_match=c(XKX = "Europe")))) %>%
  mutate_at(vars(home_continent, target_continent),
            funs(recode(., Oceania = "Asia &\nOceania", Asia = "Asia &\nOceania"))) %>%
  group_by(home_continent, target_continent) %>%
  summarize(times.marked = n()) %>%
  filter(!is.na(home_continent), !is.na(target_continent)) %>%
  group_by(home_continent) %>%
  mutate(perc.home = times.marked / sum(times.marked)) %>%
  group_by(target_continent) %>%
  mutate(perc.target = times.marked / sum(times.marked)) %>%
  ungroup()

continents.answered %>% pandoc.table()
```

```{r plot-continents-answered-river}
edges.fancy.answered <- continents.answered %>%
  select(N1 = home_continent, N2 = target_continent, Value = times.marked) %>%
  mutate(N2 = paste0(N2, " ")) %>%
  arrange(Value) %>%
  as.data.frame()

nodes.fancy.answered <- edges.fancy %>%
  select(-Value) %>%
  gather(X, ID) %>%
  mutate(x = ifelse(X == "N1", 1, 2)) %>%
  distinct(ID, X, .keep_all=TRUE) %>%
  left_join(cont.colors, by="ID") %>%
  select(ID, x, col) %>%
  as.data.frame()

continents.river.answered <- makeRiver(nodes.fancy.answered,
                                       edges.fancy.answered)

countries.answered.plot %<a-% {
  plot(continents.river.answered, srt=0, lty=0)
  text(1, 0, "HQ", adj=c(0.5, -0.5), font=2)
  text(2, 0, "Target", adj=c(0.5, -0.5), font=2)
  text(1.5, 0, "Countries answered\n", adj=c(0.5, -0.5), font=2)
}
```

#### Overall summary

```{r plot-answered-continents, fig.width=6, fig.height=3, results="asis"}
df.target.regions.answered <- continents.answered %>%
  group_by(target_continent) %>%
  summarise(times.marked = sum(times.marked)) %>%
  mutate(perc.target = times.marked / sum(times.marked)) %>%
  arrange(times.marked) %>%
  mutate(target_continent = factor(target_continent, 
                                   levels=levels(df.hq.regions$region)))
  # mutate(target_continent = fct_inorder(target_continent))

df.target.regions.answered %>% pandoc.table()

plot.target.regions.answered <- ggplot(df.target.regions.answered, 
                                       aes(x=times.marked, y=target_continent)) +
  geom_pointrangeh(aes(xmin=0, xmax=times.marked)) +
  scale_x_continuous(sec.axis = sec_axis(~ . / sum(df.target.regions.answered$times.marked),
                                         labels=scales::percent)) +
  labs(x="Respondents answered about", y=NULL) +
  theme_ath() + theme(panel.grid.major.y=element_blank())

plot.target.regions.answered +
  labs(title="Region of work country",
       subtitle="Q4.1: Which country would you like to discuss? (summarized by region)")
```

```{r plot-hq-work-regions}
plot.regions <- cbind(ggplotGrob(plot.hq.regions + 
                                   labs(title="Home countries") +
                                   theme(plot.title=element_text(size=rel(1)))),
                      ggplotGrob(plot.target.regions.answered +
                                   labs(title="Target countries") +
                                   theme(plot.title=element_text(size=rel(1)))))

fig.save.cairo(plot.regions,
               filename="3-work-hq-regions",
               width=6, height=2)
```


### Both at once

```{r plot-regions-river, fig.width=8, fig.height=3.5}
countries.marked.answered.both %<a-% {
  split.screen(c(1, 2))
  screen(1)
  countries.marked.plot
  screen(2)
  countries.answered.plot
  close.screen(all=TRUE) 
}

countries.marked.answered.both

# Save to file
filename <- "3-countries-marked-answered"

cairo_pdf(file.path(PROJHOME, "Output", "figures", paste0(filename, ".pdf")),
          width=8, height=3.5, family="Source Sans Pro")
countries.marked.answered.both
invisible(dev.off())

png(file.path(PROJHOME, "Output", "figures", paste0(filename, ".png")), 
    width=8, height=3.5, family="Source Sans Pro", 
    bg="white", units="in", res=300, type="cairo")
countries.marked.answered.both
invisible(dev.off())
```


## What do these NGOs do?

### Which issues do these NGOs work on?

```{r plot-issues-worked-on, fig.width=6, fig.height=3}
df.issues.most.clean <- survey.orgs.clean %>%
  group_by(Q3.2.clean, potential.contentiousness) %>%
  summarise(num = n()) %>%
  filter(!is.na(Q3.2.clean)) %>%
  ungroup() %>%
  arrange(desc(num)) %>%
  mutate(issue = factor(Q3.2.clean, levels=rev(unique(Q3.2.clean)), ordered=TRUE)) %>%
  mutate(prop = num / sum(num), cum.prop = cumsum(prop))

df.issues.most.denom <- sum(df.issues.most.clean$num)

plot.issues.most.clean <- ggplot(df.issues.most.clean,
                                 aes(x=num, y=issue,
                                     colour=potential.contentiousness)) +
  geom_pointrangeh(aes(xmin=0, xmax=num)) +
  scale_x_continuous(sec.axis = sec_axis(~ . / df.issues.most.denom,
                                         labels=scales::percent)) +
  scale_colour_manual(values=ath.palette("contention1"), name=NULL) +
  labs(x="Organizations", y=NULL) +
  theme_ath() + theme(legend.position=c(1, 0), legend.justification = c(1, 0),
                      legend.direction="horizontal", panel.grid.major.y=element_blank())
plot.issues.most.clean

fig.save.cairo(plot.issues.most.clean,
               filename="3-issues-worked-on",
               width=6, height=3)
```


### What kinds of activities do these NGOs engage in?

```{r plot-activities}
labels.activities <- data_frame(levels=c("aid", "education", "mobilize",
                                         "advocacy", "monitor"),
                                labels=c("Providing direct aid and services",
                                         "Engaging in research and public education",
                                         "Mobilizing people",
                                         "Engaging in advocacy",
                                         "Monitoring and assessing the effects of policies"))

df.activities <- survey.orgs.clean %>%
  select(potential.contentiousness, dplyr::contains("Q3.3"), -dplyr::contains("TEXT")) %>%
  gather(question, response, -potential.contentiousness) %>%
  mutate(question = str_replace(question, "Q3\\.3_", ""),
         question = factor(question, levels=labels.activities$levels,
                           labels=labels.activities$labels, ordered=TRUE)) %>%
  filter(!(response %in% c("Don't know", "Not applicable"))) %>%
  group_by(question, response, potential.contentiousness) %>%
  summarise(num = n()) %>%
  ungroup() %>%
  mutate(response = factor(response, levels=levels(survey.orgs.clean$Q3.3_aid), ordered=TRUE))

df.activities.plot <- df.activities %>%
  mutate(response = fct_collapse(response,
    "Almost always" = c("Always", "Most of the time"),
    "Sometimes" = c("About half the time", "Sometimes"),
    "Never" = "Never"
  )) %>%
  group_by(question, response, potential.contentiousness) %>%
  summarise(num = sum(num)) %>%
  group_by(potential.contentiousness, question) %>%
  mutate(total = sum(num)) %>%
  ungroup() %>%
  mutate(prop = num / total) %>%
  arrange(response, desc(potential.contentiousness), desc(prop)) %>%
  mutate(question = ordered(fct_inorder(question)))

plot.activities <- ggplot(df.activities.plot, aes(x=prop, y=fct_rev(response),
                                                  colour=potential.contentiousness)) +
  geom_pointrangeh(aes(xmin=0, xmax=prop), position=position_dodgev(height=0.75),
                   size=0.5) +
  labs(x="Proportion selected", y="How often INGO does work") +
  scale_colour_manual(values=ath.palette("contention1"), name=NULL) +
  scale_x_continuous(labels=scales::percent) +
  guides(colour=guide_legend(reverse=TRUE)) +
  facet_wrap(~ question) +
  theme_ath() + theme(legend.position=c(1, 0), legend.justification = c(1, 0),
                      legend.direction="vertical", strip.text=element_text(size=rel(0.75)),
                      panel.grid.major.y=element_blank())
plot.activities

fig.save.cairo(plot.activities,
               filename="3-main-activities",
               width=7, height=3)
```

```{r manual-reading-filtering}
low.contention.work <- survey.orgs.clean %>%
  filter(potential.contentiousness == "Low contention") %>%
  select(clean.id, matches("Q3\\.3_.*_TEXT"))

high.contention.work <- survey.orgs.clean %>%
  filter(potential.contentiousness == "High contention") %>%
  select(clean.id, matches("Q3\\.3_.*_TEXT"))
```


## Relationship with host governments

### Regime type

```{r plot-govt-positivity-regime}
df.govt.positivity.regime <- survey.countries.clean %>%
  select(Q4.11_collapsed, target.regime.type) %>%
  filter(!is.na(Q4.11_collapsed))

plot.govt.positivity.regime <- prodplot(df.govt.positivity.regime,
                                        ~ target.regime.type + Q4.11_collapsed, mosaic("h"),
                                        colour=NA) +
  aes(fill=target.regime.type, colour="white") +
  scale_fill_manual(values=ath.palette("regime2"), name=NULL) +
  guides(fill=FALSE) +
  theme_ath() + theme(axis.title=element_blank(),
                      panel.grid=element_blank())
```

```{r plot-govt-positivity-regime-bayes}
govt.positivity.regime.table.bayes <- survey.countries.clean %>%
  filter(!is.na(Q4.11_collapsed)) %>%
  count(Q4.11_collapsed, target.regime.type) %>%
  group_by(Q4.11_collapsed) %>%
  mutate(total = sum(n)) %>%
  filter(target.regime.type == "Autocracy") %>%
  diff.groups.bayes(cbind(n, total) ~ Q4.11_collapsed, data=., prop=TRUE)

grid.arrange(govt.positivity.regime.table.bayes$plot.groups,
             govt.positivity.regime.table.bayes$plot.diffs)
```

```{r results="asis"}
govt.positivity.regime.table.bayes$diffs.summary %>% pandoc.table()
```

### Issue contentiousness

```{r plot-govt-positivity-issue}
df.govt.positivity.issue <- survey.countries.clean %>%
  select(Q4.11_collapsed, potential.contentiousness) %>%
  filter(!is.na(Q4.11_collapsed))

plot.govt.positivity.issue <- prodplot(df.govt.positivity.issue,
                                        ~ potential.contentiousness + Q4.11_collapsed,
                                       mosaic("h"), colour=NA) +
  aes(fill=potential.contentiousness, colour="white") +
  scale_fill_manual(values=ath.palette("contention1"), name=NULL) +
  guides(fill=FALSE) +
  theme_ath() + theme(axis.title=element_blank(),
                      panel.grid=element_blank())
```

```{r plot-govt-positivity-issue-bayes}
govt.positivity.issue.table.bayes <- survey.countries.clean %>%
  filter(!is.na(Q4.11_collapsed)) %>%
  count(Q4.11_collapsed, potential.contentiousness) %>%
  group_by(Q4.11_collapsed) %>%
  mutate(total = sum(n)) %>%
  filter(potential.contentiousness == "High contention") %>%
  diff.groups.bayes(cbind(n, total) ~ Q4.11_collapsed, data=., prop=TRUE)

grid.arrange(govt.positivity.issue.table.bayes$plot.groups,
             govt.positivity.issue.table.bayes$plot.diffs)
```

```{r results="asis"}
govt.positivity.issue.table.bayes$diffs.summary %>% pandoc.table()
```

```{r plot-govt-positivity-both, fig.width=6, fig.height=1.5}
plot.govt.positivity.both <- cbind(ggplotGrob(plot.govt.positivity.regime),
                                   ggplotGrob(plot.govt.positivity.issue))
grid::grid.newpage()
grid::grid.draw(plot.govt.positivity.both)

fig.save.cairo(plot.govt.positivity.both,
               filename="3-govt-positivity-both",
               width=6, height=1.5)
```

```{r cat-var-positivity}
govt.positivity.regime.table <- survey.countries.clean %>%
  filter(!is.na(Q4.11_collapsed)) %>%
  xtabs(~ Q4.11_collapsed + target.regime.type, .)

govt.positivity.issue.table <- survey.countries.clean %>%
  filter(!is.na(Q4.11_collapsed)) %>%
  xtabs(~ Q4.11_collapsed + potential.contentiousness, .)

side.by.side(govt.positivity.regime.table,
             govt.positivity.issue.table)
```


## Experiences with regulations

### Familiarity with regulations

#### Regime type

```{r plot-familiarity-regime}
df.reg.familiarity.regime <- survey.countries.clean %>%
  select(Q4.13_collapsed, target.regime.type) %>%
  filter(!is.na(Q4.13_collapsed))

plot.reg.familiarity.regime <- prodplot(df.reg.familiarity.regime,
                                        ~ target.regime.type + Q4.13_collapsed, mosaic("h"),
                                        colour=NA) +
  aes(fill=target.regime.type, colour="white") +
  scale_fill_manual(values=ath.palette("regime2"), name=NULL) +
  guides(fill=FALSE) +
  theme_ath() + theme(axis.title=element_blank(),
                      panel.grid=element_blank())
```

```{r plot-familiarity-regime-bayes}
reg.familiarity.regime.table.bayes <- survey.countries.clean %>%
  filter(!is.na(Q4.13_collapsed)) %>%
  count(Q4.13_collapsed, target.regime.type) %>%
  group_by(Q4.13_collapsed) %>%
  mutate(total = sum(n)) %>%
  filter(target.regime.type == "Autocracy") %>%
  diff.groups.bayes(cbind(n, total) ~ Q4.13_collapsed, data=., prop=TRUE)

grid.arrange(reg.familiarity.regime.table.bayes$plot.groups,
             reg.familiarity.regime.table.bayes$plot.diffs)
```

```{r results="asis"}
reg.familiarity.regime.table.bayes$diffs.summary %>% pandoc.table()
```

#### Issue contentiousness

```{r plot-familiarity-issue}
df.reg.familiarity.issue <- survey.countries.clean %>%
  select(Q4.13_collapsed, potential.contentiousness) %>%
  filter(!is.na(Q4.13_collapsed))

plot.reg.familiarity.issue <- prodplot(df.reg.familiarity.issue,
                                        ~ potential.contentiousness + Q4.13_collapsed, mosaic("h"),
                                        colour=NA) +
  aes(fill=potential.contentiousness, colour="white") +
  scale_fill_manual(values=ath.palette("contention1"), name=NULL) +
  guides(fill=FALSE) +
  theme_ath() + theme(axis.title=element_blank(),
                      panel.grid=element_blank())
```

```{r plot-familiarity-issue-bayes}
reg.familiarity.issue.table.bayes <- survey.countries.clean %>%
  filter(!is.na(Q4.13_collapsed)) %>%
  count(Q4.13_collapsed, potential.contentiousness) %>%
  group_by(Q4.13_collapsed) %>%
  mutate(total = sum(n)) %>%
  filter(potential.contentiousness == "High contention") %>%
  diff.groups.bayes(cbind(n, total) ~ Q4.13_collapsed, data=., prop=TRUE)

grid.arrange(reg.familiarity.issue.table.bayes$plot.groups,
             reg.familiarity.issue.table.bayes$plot.diffs)
```

```{r results="asis"}
reg.familiarity.issue.table.bayes$diffs.summary %>% pandoc.table()
```

#### Both

```{r plot-familiarity-both, fig.width=6, fig.height=1.5}
plot.familiarity.both <- cbind(ggplotGrob(plot.reg.familiarity.regime),
                               ggplotGrob(plot.reg.familiarity.issue))
grid::grid.newpage()
grid::grid.draw(plot.familiarity.both)

fig.save.cairo(plot.familiarity.both,
               filename="3-familiarity-both",
               width=6, height=1.5)
```

```{r cat-var-familiarity}
reg.familiarity.regime.table <- survey.countries.clean %>%
  filter(!is.na(Q4.13_collapsed)) %>%
  xtabs(~ Q4.13_collapsed + target.regime.type, .)

reg.familiarity.issue.table <- survey.countries.clean %>%
  filter(!is.na(Q4.13_collapsed)) %>%
  xtabs(~ Q4.13_collapsed + potential.contentiousness, .)

side.by.side(reg.familiarity.regime.table,
             reg.familiarity.issue.table)
```


### Frequency of changes

```{r plot-frequency-regime, fig.width=3, fig.height=1.5}
df.frequency.regime <- survey.countries.clean %>%
  select(Q4.14_collapsed, target.regime.type) %>%
  filter(!is.na(Q4.14_collapsed))

plot.frequency.regime <- prodplot(df.frequency.regime,
                                  ~ target.regime.type + Q4.14_collapsed, mosaic("h"),
                                  colour=NA) +
  aes(fill=target.regime.type, colour="white") +
  scale_fill_manual(values=ath.palette("regime2"), name=NULL) +
  guides(fill=FALSE) +
  theme_ath() + theme(axis.title=element_blank(),
                      panel.grid=element_blank())
plot.frequency.regime

fig.save.cairo(plot.frequency.regime,
               filename="3-frequency",
               width=3, height=1.5)

frequency.regime.table <- survey.countries.clean %>%
  filter(!is.na(Q4.14_collapsed)) %>%
  xtabs(~ Q4.14_collapsed + target.regime.type, .)

analyze.cat.var(frequency.regime.table)
```

```{r plot-frequency-regime-bayes}
frequency.regime.table.bayes <- survey.countries.clean %>%
  filter(!is.na(Q4.14_collapsed)) %>%
  count(Q4.14_collapsed, target.regime.type) %>%
  group_by(Q4.14_collapsed) %>%
  mutate(total = sum(n)) %>%
  filter(target.regime.type == "Autocracy") %>%
  diff.groups.bayes(cbind(n, total) ~ Q4.14_collapsed, data=., prop=TRUE)

grid.arrange(frequency.regime.table.bayes$plot.groups,
             frequency.regime.table.bayes$plot.diffs)
```

```{r results="asis"}
frequency.regime.table.bayes$diffs.summary %>% pandoc.table()
```

### How NGOs find out about changes

```{r plot-change-how, fig.width=5, fig.height=2}
df.change.how <- survey.countries.clean %>%
  unnest(Q4.15_value) %>%
  group_by(Q4.15_value) %>%
  summarise(num = n()) %>%
  arrange(desc(num)) %>%
  filter(!is.na(Q4.15_value)) %>%
  mutate(how = ordered(fct_inorder(Q4.15_value))) %>%
  mutate(how = fct_recode(how, "Newspapers, television,\nand other media" = 
                            "Newspapers, television, and other media", NULL = "Don't know")) %>%
  filter(!is.na(how))

plot.change.how <- ggplot(df.change.how, aes(x=num, y=fct_rev(how))) + 
  geom_pointrangeh(aes(xmin=0, xmax=num)) +
  scale_x_continuous(sec.axis = sec_axis(~ . / nrow(survey.countries.clean),
                                         labels=scales::percent)) +
  labs(x="Times selected", y=NULL) +
  theme_ath() + theme(panel.grid.major.y=element_blank())
plot.change.how

fig.save.cairo(plot.change.how,
               filename="3-change-how-find-out",
               width=5, height=2)

# What are the other ways?
df.change.how.other <- survey.countries.clean %>%
  filter(!is.na(Q4.15_other_TEXT)) %>%
  select(clean.id, Q4.15_other_TEXT) %>%
  arrange(Q4.15_other_TEXT)
```

### Are NGOs registered?

There's a slight difference in how NGOs register across regimes, with more NGOs registering in autocracies than in democracies, perhaps because they are more likely to be *required* to register in autocracies. The difference is not significant, though. There is no significant difference in the registration status of low and high contentious INGOs.

```{r plot-registration-regime}
df.registered.regime <- survey.countries.clean %>%
  filter(!is.na(Q4.4_collapsed)) %>%
  select(Q4.4_collapsed, target.regime.type)

plot.registered.regime <- prodplot(df.registered.regime,
                                   ~ target.regime.type + Q4.4_collapsed,
                                   mosaic("h"), 
                                   colour=NA) + 
  aes(fill=target.regime.type, colour="white") + 
  scale_fill_manual(values=ath.palette("regime2"), name=NULL) +
  guides(fill=FALSE) +
  theme_ath() + theme(axis.title=element_blank(),
                      panel.grid=element_blank())
```

```{r plot-registration-issue}
df.registered.issue <- survey.countries.clean %>%
  filter(!is.na(Q4.4_collapsed)) %>%
  select(Q4.4_collapsed, potential.contentiousness)

plot.registered.issue <- prodplot(df.registered.issue,
                                  ~ potential.contentiousness + Q4.4_collapsed,
                                  mosaic("h"), 
                                  colour=NA) + 
  aes(fill=potential.contentiousness, colour="white") + 
  scale_fill_manual(values=ath.palette("contention1"), name=NULL) +
  guides(fill=FALSE) +
  theme_ath() + theme(axis.title=element_blank(),
                      panel.grid=element_blank())
```

```{r plot-registration-both, fig.width=6, fig.height=1.5}
plot.registration.both <- cbind(ggplotGrob(plot.registered.regime),
                                ggplotGrob(plot.registered.issue))
grid::grid.newpage()
grid::grid.draw(plot.registration.both)

fig.save.cairo(plot.registration.both,
               filename="3-registration-both",
               width=6, height=1.5)
```

```{r cat-var-registered}
registered.table <- survey.countries.clean %>%
  filter(!is.na(Q4.4_collapsed)) %>%
  xtabs(~ Q4.4_collapsed + target.regime.type, .)

registered.table.issue <- survey.countries.clean %>%
  filter(!is.na(Q4.4_collapsed)) %>%
  xtabs(~ Q4.4_collapsed + potential.contentiousness, .)

side.by.side(registered.table,
             registered.table.issue)
```


## Restrictions on INGOs

### Routine regulation vs. burdensome regulation

```{r plot-dcjw-registration, fig.width=6, fig.height=2}
dcjw <- readRDS(file.path(PROJHOME, "Data", 
                          "data_processed", "dcjw.rds"))

dcjw.registration <- dcjw %>%
  mutate(question = recode(question,
                           q_2a = "registration",
                           q_2b = "burdensome",
                           q_2c  = "appeal",
                           q_2d  = "diff.foreign")) %>%
  filter(question %in% c("registration", "burdensome"))

dcjw.registration.panel <- dcjw.registration %>%
  tidyr::expand(Country, question, 
                year = min(.$year, na.rm=TRUE):2013) %>%
  left_join(dcjw.registration, by=c("Country", "question", "year")) %>%
  # Bring most recent legislation forward
  group_by(Country, question) %>%
  mutate(value = zoo::na.locf(value, na.rm=FALSE)) %>%
  ungroup() %>%
  mutate(value = ifelse(is.na(value), 0, value)) %>%
  mutate(cowcode = countrycode(Country, "country.name", "cown",
                               custom_match=c(`Serbia` = 340L)))

regime.types <- full.data %>%
  select(cowcode, year.num, gwf.ever.autocracy) %>%
  group_by(cowcode) %>%
  summarise(ever.autocracy = any(gwf.ever.autocracy, na.rm=TRUE))

dcjw.registration.summary <- dcjw.registration.panel %>%
  left_join(regime.types, by="cowcode") %>%
  # There are a few countries that didn't have regime type from full.data
  mutate(ever.autocracy = case_when(
    .$Country %in% c("Bahrain", "Equatorial Guinea", "Kuwait", "Oman",
                     "Singapore", "United Arab Emirates") ~ TRUE,
    .$Country == "Serbia" ~ FALSE,
    TRUE ~ .$ever.autocracy
  )) %>%
  group_by(year, question, ever.autocracy) %>%
  summarise(prop.with.reg = sum(value) / n()) %>%
  ungroup() %>%
  mutate(question = 
           factor(question, levels=c("registration", "burdensome"),
                  labels=c("Registration required", 
                           "Registration burdensome"))) %>%
  mutate(ever.autocracy = 
           factor(ever.autocracy, levels=c(TRUE, FALSE),
                  labels=c("Autocracies", "Democracies"))) %>%
  filter(year > 1990)

plot.dcjw.reg.regime <- ggplot(dcjw.registration.summary, 
                               aes(x=year, y=prop.with.reg, colour=question)) + 
  geom_line() + 
  labs(x=NULL, y="Proportion of countries\nwith regulations") +
  scale_y_continuous(labels=scales::percent) +
  coord_cartesian(ylim=c(0, 0.65)) +
  scale_colour_manual(values=ath.palette("palette1"), name=NULL) +
  theme_ath() +
  facet_wrap(~ ever.autocracy)
plot.dcjw.reg.regime

fig.save.cairo(plot.dcjw.reg.regime,
               filename="3-dcjw-reg-regime",
               width=6, height=2)
```


### Overall restriction

#### Regime type

```{r plot-restrictions-regime}
df.restriction.regime <- survey.countries.clean %>%
  select(Q4.17_collapsed, target.regime.type) %>%
  filter(!is.na(Q4.17_collapsed))

plot.restriction.regime <- prodplot(df.restriction.regime,
                                    ~ target.regime.type + Q4.17_collapsed, mosaic("h"),
                                    colour=NA) +
  aes(fill=target.regime.type, colour="white") +
  scale_fill_manual(values=ath.palette("regime2"), name=NULL) +
  guides(fill=FALSE) +
  theme_ath() + theme(axis.title=element_blank(),
                      panel.grid=element_blank())
```

```{r plot-restrictions-regime-bayes}
restrictions.regime.table.bayes <- survey.countries.clean %>%
  filter(!is.na(Q4.17_collapsed)) %>%
  count(Q4.17_collapsed, target.regime.type) %>%
  group_by(Q4.17_collapsed) %>%
  mutate(total = sum(n)) %>%
  filter(target.regime.type == "Autocracy") %>%
  diff.groups.bayes(cbind(n, total) ~ Q4.17_collapsed, data=., prop=TRUE)

grid.arrange(restrictions.regime.table.bayes$plot.groups,
             restrictions.regime.table.bayes$plot.diffs)
```

```{r results="asis"}
restrictions.regime.table.bayes$diffs.summary %>% pandoc.table()
```

#### Issue contentiousness

```{r plot-restrictions-issue}
df.restriction.issue <- survey.countries.clean %>%
  select(Q4.17_collapsed, potential.contentiousness) %>%
  filter(!is.na(Q4.17_collapsed))

plot.restriction.issue <- prodplot(df.restriction.issue,
                                   ~ potential.contentiousness + Q4.17_collapsed, mosaic("h"),
                                   colour=NA) +
  aes(fill=potential.contentiousness, colour="white") +
  scale_fill_manual(values=ath.palette("contention1"), name=NULL) +
  guides(fill=FALSE) +
  theme_ath() + theme(axis.title=element_blank(),
                      panel.grid=element_blank())
```

```{r plot-restrictions-issue-bayes}
restrictions.issue.table.bayes <- survey.countries.clean %>%
  filter(!is.na(Q4.17_collapsed)) %>%
  count(Q4.17_collapsed, potential.contentiousness) %>%
  group_by(Q4.17_collapsed) %>%
  mutate(total = sum(n)) %>%
  filter(potential.contentiousness == "High contention") %>%
  diff.groups.bayes(cbind(n, total) ~ Q4.17_collapsed, data=., prop=TRUE)

grid.arrange(restrictions.issue.table.bayes$plot.groups,
             restrictions.issue.table.bayes$plot.diffs)
```

```{r results="asis"}
restrictions.issue.table.bayes$diffs.summary %>% pandoc.table()
```

#### Both

```{r plot-restriction-both, fig.width=6, fig.height=1.5}
plot.restriction.both <- cbind(ggplotGrob(plot.restriction.regime),
                               ggplotGrob(plot.restriction.issue))
grid::grid.newpage()
grid::grid.draw(plot.restriction.both)

fig.save.cairo(plot.restriction.both,
               filename="3-restriction-both",
               width=6, height=1.5)
```

```{r cat-var-restriction}
restriction.regime.table <- survey.countries.clean %>%
  filter(!is.na(Q4.17_collapsed)) %>%
  xtabs(~ Q4.17_collapsed + target.regime.type, .)

restriction.issue.table <- survey.countries.clean %>%
  filter(!is.na(Q4.17_collapsed)) %>%
  xtabs(~ Q4.17_collapsed + potential.contentiousness, .)

side.by.side(restriction.regime.table, restriction.issue.table)
```


### Registration and restrictions

```{r plot-registration-restrictions, fig.width=6.5, fig.height=1.5}
df.restriction.reg.issue <- survey.countries.clean %>%
  select(Q4.17_collapsed, Q4.4_collapsed, target.regime.type) %>%
  filter(!is.na(Q4.17_collapsed), !is.na(Q4.4_collapsed))

plot.restriction.reg.issue <- prodplot(df.restriction.reg.issue,
                                       ~ Q4.4_collapsed + Q4.17_collapsed +
                                         target.regime.type, 
                                       mosaic("h")) +
  aes(fill=Q4.4_collapsed, linetype=target.regime.type, colour="white") +
  scale_fill_manual(values=ath.palette("wars")) +
  scale_linetype_manual(values=c("blank", "dotted")) +
  guides(fill=FALSE, linetype=FALSE) +
  theme_ath() + theme(axis.title=element_blank(),
                      panel.grid=element_blank())
plot.restriction.reg.issue

fig.save.cairo(plot.restriction.reg.issue,
               filename="3-restrictions-registration",
               width=6.5, height=1.5)

restriction.reg.issue.table <- survey.countries.clean %>%
  filter(!is.na(Q4.17_collapsed), !is.na(Q4.4_collapsed)) %>%
  xtabs(~ target.regime.type + Q4.17_collapsed + Q4.4_collapsed, .)

analyze.cat.var(restriction.reg.issue.table)
```

#### Both registration and registration + restrictions

```{r plot-registration-all, fig.width=6.5, fig.height=3}
# TODO: The only way to get the axis labels to align correctly is to use
# gtable, but it gets mad when combining unbalanced rbind(cbind())
# combinations, so for now I have to live with the ugly arrangeGrob arrangement
# plot.registration.all <- rbind(ggplotGrob(plot.registered.regime),
#                                ggplotGrob(plot.blank),
#                                ggplotGrob(plot.restriction.reg.issue))
# 
# panels <- plot.registration.all$layout$t[
#   grep("panel", plot.registration.all$layout$name)]
# plot.registration.all$heights[panels] <- unit(c(1, 0.1, 2), "null")

plot.registration.all <- arrangeGrob(plot.registration.both,
                                     plot.restriction.reg.issue,
                                     heights=c(1.25, 2))

grid::grid.newpage()
grid::grid.draw(plot.registration.all)

fig.save.cairo(plot.registration.all,
               filename="3-registration-all",
               width=6.5, height=3)
```

```{r}
# ### Staffing details
# 
# #### Full time employees
# df.employees <- survey.orgs.clean %>%
#   select(Q3.4.num) %>%
#   filter(!is.na(Q3.4.num))
# 
# plot.employees <- ggplot(df.employees, aes(x=Q3.4.num)) +
#   geom_histogram(binwidth=0.5) +
#   labs(x="Number of employees (natural log)", y="Frequency",
#        title="How many employees do NGOs use?",
#        subtitle="Q3.4: Approximately how many full-time employees does your organization have?") +
#   scale_x_continuous(trans="log1p", breaks=c(0, 10^(0:5)), labels=scales::comma) +
#   theme_ath()
# 
# plot.employees
# 
# 
# #### Volunteers
# df.volunteers <- survey.orgs.clean %>%
#   select(Q3.5.num) %>%
#   filter(!is.na(Q3.5.num))
# 
# plot.volunteers <- ggplot(df.volunteers, aes(x=Q3.5.num)) +
#   geom_histogram(binwidth=0.5) +
#   labs(x="Number of volunteers (natural log)", y="Frequency",
#        title="How many volunteers do NGOs use?",
#        subtitle="Q3.5: Approximately how many volunteers does your organization have?") +
#   scale_x_continuous(trans="log1p", breaks=c(0, 10^(0:6), 5000000), labels=scales::comma) +
#   theme_ath()
# 
# plot.volunteers
# 
# 
# ### Collaboration
# df.collaboration <- survey.orgs.clean %>%
#   unnest(Q3.6_value) %>%
#   group_by(Q3.6_value) %>%
#   summarise(num = n()) %>%
#   arrange(desc(num)) %>%
#   filter(!is.na(Q3.6_value)) %>%
#   mutate(partner = factor(Q3.6_value, levels=rev(Q3.6_value), ordered=TRUE))
# 
# # Add line break to label
# levels(df.collaboration$partner)[levels(df.collaboration$partner) == "We do not collaborate with other organizations or institutions"] <-
#   "We do not collaborate with other\norganizations or institutions"
# 
# plot.collaboration <- ggplot(df.collaboration, aes(x=num, y=partner)) + 
#   geom_barh(stat="identity") + 
#   scale_x_continuous(expand=c(0, 0)) +
#   labs(x="Times selected", y=NULL,
#        title="Do NGOs collaborate with other organizations?",
#        subtitle="Q3.6: Does your organization collaborate with any of these organizations\nor institutions? (multiple answers allowed)") +
#   theme_ath()
# 
# plot.collaboration
# 
# What are the other organizations?
# df.collaboration.other <- survey.orgs.clean %>%
#   filter(!is.na(Q3.6_other_TEXT)) %>%
#   mutate(collaboration.other = str_to_title(Q3.6_other_TEXT)) %>% 
#   group_by(collaboration.other) %>%
#   summarise(num = n()) %>%
#   arrange(desc(num))
# 
# datatable(df.collaboration.other)
# 
# Seems to mostly be universities, research centers, foundations, and
# religious groups.
# 
# 
# #### Specific organizations and institutions
# 
# Q3.7: Please list a few of the organizations or institutions you partner
# with most often:
# df.collaboration.partners <- survey.orgs.clean %>%
#   filter(!is.na(Q3.7)) %>% select(Q3.7) %>% arrange(Q3.7)
# 
# datatable(df.collaboration.partners)
# 
# 
# ### Funding
# labels.funding <- data_frame(levels=c("individual", "corporate", "foundation", 
#                                       "home_govt", "host_govt", "other"),
#                              labels=c("Individual donations",
#                                       "Corporate donations",
#                                       "Foundation donations",
#                                       "Grants from home country",
#                                       "Grants from host country",
#                                       "Other"))
# 
# df.funding <- survey.orgs.clean %>%
#   select(dplyr::contains("Q3.8"), -dplyr::contains("TEXT")) %>%
#   gather(question, response) %>%
#   mutate(question = str_replace(question, "Q3\\.8_", ""),
#          question = factor(question, levels=labels.funding$levels,
#                            labels=labels.funding$labels, ordered=TRUE)) %>%
#   filter(!(response %in% c("Don't know", "Not applicable"))) %>%
#   group_by(question, response) %>%
#   summarise(num = n()) %>%
#   ungroup() %>%
#   mutate(response = factor(response, 
#                            levels=levels(survey.orgs.clean$Q3.8_individual), 
#                            ordered=TRUE))
# 
# plot.funding <- ggplot(df.funding, aes(y=num, x=response)) +
#   geom_bar(stat="identity") +
#   labs(y="Number of responses", x=NULL,
#        title="Where does NGO funding come from?",
#        subtitle="Q3.8: How much of your organization’s funding comes from each of these sources?") +
#   facet_wrap(~ question, ncol=1) + 
#   theme_ath()
# 
# plot.funding
# 
# What other sources of funding do NGOs use?
# df.funding.other <- survey.orgs.clean %>%
#   filter(!is.na(Q3.8_other_TEXT)) %>%
#   arrange(Q3.8_other_TEXT) %>% select(Q3.8_other_TEXT)
# 
# datatable(df.funding.other)
# 
# The EU, churches, membership fees, etc.
# 
# 
# 
# ## Responses to reactions
# 
# #######
# 
# reactions <- tribble(
#   ~reaction,              ~reaction.clean,
#   "Q4.21_funding",        "Changed sources of funding",
#   "Q4.21_issues",         "Changed issues worked on",
#   "Q4.21_comm_govt",      "Changed how communicate\nwith the government",
#   "Q4.21_comm_donors",    "Changed how communicate\nwith donors",
#   "Q4.21_locations",      "Changed locations work in",
#   "Q4.21_country_office", "Changed location of country office",
#   "Q4.21_local_staff",    "Used more local staff/volunteers",
#   "Q4.21_foreign_staff",  "Used more foreign staff/volunteers"
# )
# 
# reaction.counts <- survey.clean.all %>%
#   select(clean.id, loop.number, starts_with("Q4.21"), -dplyr::contains("_TEXT")) %>%
#   gather(reaction, value, -c(clean.id, loop.number)) %>%
#   filter(value == "Yes") %>%
#   count(reaction) %>%
#   arrange(n) %>%
#   left_join(reactions, by="reaction") %>%
#   mutate(reaction.clean = ordered(fct_inorder(reaction.clean)))
# 
# # TODO: Percent labels along top
# plot.reaction.counts <- ggplot(reaction.counts, aes(y=reaction.clean, x=n)) +
#   geom_barh(stat="identity") +
#   labs(x=NULL, y=NULL) + 
#   theme_ath() + theme(panel.grid.major.y=element_blank())
# plot.reaction.counts
# 
# fig.save.cairo(plot.reaction.counts, filename="3-reaction-counts",
#                width=4.5, height=2.5)
# 
# 
# How do different types of INGOs react differently in different political contexts?
# reaction.counts <- survey.clean.all %>%
#   select(clean.id, loop.number, starts_with("Q4.21"), -dplyr::contains("_TEXT"),
#          potential.contentiousness, target.regime.type) %>%
#   gather(reaction, value, -c(clean.id, loop.number,
#                              potential.contentiousness, target.regime.type)) %>%
#   filter(value == "Yes") %>%
#   count(reaction, potential.contentiousness, target.regime.type) %>%
#   group_by(potential.contentiousness, target.regime.type) %>%
#   mutate(total = sum(n), prop = n / total) %>%
#   left_join(reactions, by="reaction") %>%
#   arrange(potential.contentiousness, target.regime.type, prop) %>%
#   mutate(reaction.clean = ordered(fct_inorder(reaction.clean)))
# 
# plot.reactions.regime.issue <- ggplot(reaction.counts,
#                                       aes(y=reaction.clean, x=prop)) +
#   geom_barh(stat="identity") +
#   labs(x=NULL, y=NULL) + 
#   scale_x_continuous(labels=scales::percent) +
#   theme_ath() + theme(panel.grid.major.y=element_blank()) +
#   facet_wrap(~ target.regime.type + potential.contentiousness)
# plot.reactions.regime.issue
# 
# The most common reaction to restrictions is to turn to more local staff and volunteers, likely because it provides insulation against accuations of being tools of foreign governments (and it gives organizations a better connection to trends on the ground).
# 
# However, though this is the most frequent reaction for highly contentious NGOs working in autocracies, it is less common compared to their low contention counterparts. FREE RESPONSE ABOUT THAT HERE. Or in-person interview with human rights organization and how they purposely don't use local staff
# 
# INGOs that work in autocracies change the sources of their funding more often, which makes sense given the increase in restrictions on foreign funding—that's one of the more popular types of NGO restriction. In general, contentiousness of the issue doesn't do much for INGOs working in autocracies, since the distribution of reactions is pretty much the same, with two exceptions: more high contention INGOs in autocracies change the locations they work in and change the locations of their country offices. 
# 
# Interestingly, INGOS that work in democracies do differ slighly by contentiousness. High contention INGOs change the issues they work on more frequently compared to their less contentious counterparts, change the locations they work in less often, and change their sources of funding more often
# 
# Number of changes made. Organizations were offered 8 types of reactions - on average, how many did they choose? More in autcracies (21% ; 1.7 reactions) than in democracies (13.8%; 1.1 reactions), with a 9x% chance that the difference is greater than zero. Issue contentiousness does not matter, though. Both high and low contention NGOs selected 1.3 reactions
# 
# num.changes <- survey.clean.all %>%
#   select(clean.id, loop.number, starts_with("Q4.21"), -dplyr::contains("_TEXT")) %>%
#   gather(reaction, value, -c(clean.id, loop.number)) %>%
#   filter(value == "Yes") %>%
#   group_by(clean.id, loop.number) %>%
#   summarize(num.changes = length(value))
# 
# survey.clean.num.changes <- survey.clean.all %>%
#   left_join(num.changes, by=c("clean.id", "loop.number"))
# 
# survey.clean.num.changes %>%
#   group_by(target.regime.type) %>%
#   summarise(avg.pct.changed = mean(Q4.21_percent.changed, na.rm=TRUE)) %>%
#   mutate(avg.converted = avg.pct.changed * 8)
# 
# survey.clean.num.changes %>%
#   group_by(potential.contentiousness) %>%
#   summarise(avg.pct.changed = mean(Q4.21_percent.changed, na.rm=TRUE)) %>%
#   mutate(avg.converted = avg.pct.changed * 8)
# 
# ggplot(survey.clean.num.changes, aes(x=num.changes)) + 
#   geom_density() + 
#   facet_wrap(~ target.regime.type)
# 
# 
# INGOs make more changes in response to feeling restricted, which makes
# sense, since they have to respond more to harsher restrictions
# 
# asdf <- survey.clean.num.changes %>%
#   filter(!is.na(Q4.17), Q4.17 != "Don’t know") %>%
#   group_by(Q4.17) %>%
#   summarise(
#     num = n(),
#     avg.num.changed = mean(num.changes, na.rm=TRUE),
#     avg.pct.changed = mean(Q4.21_percent.changed, na.rm=TRUE)
#     ) %>%
#   mutate(avg.converted = avg.pct.changed * 8)
# ggplot(asdf, aes(x=avg.converted, y=Q4.17)) + geom_barh(stat="identity")
# 
# Relationship with the government matters. INGOs that have a poor
# relationship with the government tend to make more changes. This possibly
# reflects differences in application of the law? Like, governments force more
# reactions and changes from organizations they don't like?
# 
# asdf <- survey.clean.num.changes %>%
#   filter(!is.na(Q4.11), Q4.11 != "Don't know", Q4.11 != "Prefer not to answer") %>%
#   group_by(Q4.11, target.regime.type) %>%
#   summarise(
#     num = n(),
#     avg.num.changed = mean(num.changes, na.rm=TRUE),
#     avg.pct.changed = mean(Q4.21_percent.changed, na.rm=TRUE)
#   ) %>%
#   mutate(avg.converted = avg.pct.changed * 8)
# ggplot(asdf, aes(x=avg.converted, y=Q4.11)) + geom_barh(stat="identity") + facet_wrap(~ target.regime.type)
# 
# 
# 
# asdf <- survey.clean.num.changes %>%
#   filter(!is.na(Q4.17), !is.na(Q4.11)) %>%
#   filter(Q4.17 != "Don’t know", Q4.11 != "Don't know", Q4.11 != "Prefer not to answer") %>%
#   group_by(Q4.17, Q4.11) %>%
#   summarise(
#     num = n(),
#     avg.num.changed = mean(num.changes, na.rm=TRUE),
#     avg.pct.changed = mean(Q4.21_percent.changed, na.rm=TRUE)
#   ) %>%
#   mutate(avg.converted = avg.pct.changed * 8)
# 
# ggplot(asdf, aes(x=avg.converted, y=Q4.11)) + geom_barh(stat="identity") + facet_wrap(~ Q4.17)
# 
# # Changes ~ relationship with government
# survey.clean.num.changes %>%
#   group_by(Q4.11) %>%
#   summarise(avg.pct.changed = mean(Q4.21_percent.changed, na.rm=TRUE))
#   
# asdf <- survey.clean.all %>%
#   filter(Q2.5_count < 100)
# 
# ggplot(asdf, aes(x=as.numeric(Q2.5_count), y=Q4.21_percent.changed)) + 
#   geom_point() + geom_smooth()
# 
# num.changes <- survey.clean.all %>%
#   select(clean.id, loop.number, starts_with("Q4.21"), -dplyr::contains("_TEXT")) %>%
#   gather(reaction, value, -c(clean.id, loop.number)) %>%
#   filter(value == "Yes") %>%
#   group_by(clean.id, loop.number) %>%
#   summarize(num.changes = length(value))
# 
# survey.clean.num.changes <- survey.clean.all %>%
#   left_join(num.changes, by=c("clean.id", "loop.number"))
# 
# 
# survey.clean.num.changes %>%
#   group_by(target.regime.type) %>%
#   summarise(asdf = mean(num.changes, na.rm=TRUE))
# 
# survey.clean.num.changes %>%
#   group_by(potential.contentiousness) %>%
#   summarise(asdf = mean(num.changes, na.rm=TRUE))
# 
# # General overview
# # How restricted they feel
# # Reactions
# # DV = reactions to restrictions
# # What explains those reactions
```
